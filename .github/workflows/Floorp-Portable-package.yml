# GitHub Actions 工作流：floorp 浏览器便携版打包
name: floorp Portable Build

on:
  workflow_dispatch:
  push:
    branches: [main, master]
  schedule:
    - cron: '0 0 * * *'

jobs:
  build-floorp:
    runs-on: windows-latest
    permissions:
      contents: write
      packages: write

    steps:
    # 检出代码仓库
    - name: Checkout repository
      uses: actions/checkout@v4

    # 检查 floorp 浏览器版本更新
    - name: Check floorp Browser version
      id: version-check
      run: |
        # 获取最新版本信息
        $latest_url = "https://api.github.com/repos/Floorp-Projects/Floorp/releases/latest"
        $response = Invoke-RestMethod -Uri $latest_url
        $latest_version = $response.tag_name
        echo "Latest version: $latest_version"
        echo "floorp_version=$latest_version" >> $env:GITHUB_OUTPUT
        
        # 获取下载链接
        $download_url = ""
        foreach ($asset in $response.assets) {
            if ($asset.name -match "floorp-windows-x86_64.installer.exe") {
                $download_url = $asset.browser_download_url
                break
            }
        }
        if (-not $download_url) {
            Write-Error "Could not find Floorp installer asset"
            exit 1
        }
        echo "download_url=$download_url" >> $env:GITHUB_OUTPUT
        
        # 检查触发事件类型
        $trigger_event = "${{ github.event_name }}"
        $should_build = "true"
        $build_reason = $trigger_event
        
        # 定时触发时检查版本更新
        if ($trigger_event -eq "schedule") {
          $version_file = "last_version.txt"
          if (Test-Path $version_file) {
            $last_version = Get-Content $version_file
            if ($last_version -eq $latest_version) {
              echo "No update available. Skipping build."
              $should_build = "false"
              $build_reason = "no_update"
            } else {
              $build_reason = "version_update"
            }
          } else {
            $build_reason = "first_run"
          }
        }
        
        # 保存版本信息
        $latest_version | Out-File -FilePath "last_version.txt" -Encoding UTF8
        echo "should_build=$should_build" >> $env:GITHUB_OUTPUT
        echo "build_reason=$build_reason" >> $env:GITHUB_OUTPUT

    # 准备构建环境
    - name: Checkout Browser-builder
      if: steps.version-check.outputs.should_build == 'true'
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository_owner }}/Browser-builder
        path: builder

    - name: Set up Python
      if: steps.version-check.outputs.should_build == 'true'
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      if: steps.version-check.outputs.should_build == 'true'
      run: |
        pip install -r builder/requirements.txt

    # 执行 Python 构建脚本
    - name: Build Portable Package
      if: steps.version-check.outputs.should_build == 'true'
      id: build
      run: |
        python builder/build.py --browser floorp --version "${{ steps.version-check.outputs.floorp_version }}" --url "${{ steps.version-check.outputs.download_url }}" --libportable libportable --launcher 开始.bat

    # 创建 GitHub Release 并上传文件
    - name: Create Release and Upload Package
      if: steps.version-check.outputs.should_build == 'true'
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version-check.outputs.floorp_version }}
        name: floorp Browser Portable ${{ steps.version-check.outputs.floorp_version }}
        body: |
          floorp Browser ${{ steps.version-check.outputs.floorp_version }} 便携版
          这是一个自动构建的 floorp 浏览器便携版本，基于 libportable 项目。

          使用方法：
          1. 下载压缩包文件
          2. 解压到任意目录
          3. 运行 开始.bat 即可创建快捷方式
        draft: false
        prerelease: false
        files: ${{ steps.build.outputs.artifact_path }}

  cleanup:
    if: always()
    needs: build-floorp
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 10
